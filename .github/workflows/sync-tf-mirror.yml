name: Sync TF Mirror (Native Lock & Mirror)

on:
  schedule:
    - cron: '0 4 * * 0' # æ¯å‘¨æ—¥è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "latest"

      - name: Prepare & Lock Dependencies
        run: |
          mkdir -p tf-worker
          cd tf-worker

          # 1. ç”Ÿæˆ main.tf (åªåŒ…å«è½»é‡çº§å·¥å…·)
          cat > main.tf <<EOF
          terraform {
            required_providers {
              random   = { source = "hashicorp/random" }
              null     = { source = "hashicorp/null" }
              time     = { source = "hashicorp/time" }
              local    = { source = "hashicorp/local" }
              tls      = { source = "hashicorp/tls" }
              http     = { source = "hashicorp/http" }
              archive  = { source = "hashicorp/archive" }
              external = { source = "hashicorp/external" }
            }
          }
          EOF

          # 2. åˆå§‹åŒ– (åªä¸‹è½½å½“å‰ Linux çŽ¯å¢ƒçš„åŒ…)
          terraform init

          # 3. å…³é”®æ­¥éª¤ï¼šé”å®šå¤šå¹³å°
          # è¿™ä¼šå¼ºåˆ¶è®¡ç®— Win/Mac/Linux çš„å“ˆå¸Œå€¼å¹¶å†™å…¥ .terraform.lock.hcl
          echo "ðŸ”’ Locking dependencies for cross-platform..."
          terraform providers lock \
            -platform=linux_amd64 \
            -platform=linux_arm64 \
            -platform=darwin_amd64 \
            -platform=darwin_arm64 \
            -platform=windows_amd64

      - name: Execute Native Mirroring
        run: |
          cd tf-worker
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p ../public/tf-mirror

          # 4. æ‰§è¡Œå®˜æ–¹é•œåƒå‘½ä»¤
          # å®ƒä¼šè¯»å– .terraform.lock.hclï¼Œè‡ªåŠ¨ä¸‹è½½æ‰€æœ‰å¹³å°çš„åŒ…
          # å¹¶æŒ‰ç…§ standard filesystem layout æ”¾ç½®
          echo "ðŸ“¦ Mirroring to ../public/tf-mirror..."
          terraform providers mirror ../public/tf-mirror

      - name: Generate Index JSON (Required for Web Mirror)
        # Terraform åŽŸç”Ÿå‘½ä»¤åªç”Ÿæˆæ–‡ä»¶ç»“æž„ï¼Œä¸ç”Ÿæˆ index.json
        # å¿…é¡»è¡¥å……è¿™ä¸€æ­¥ï¼Œå¦åˆ™ network_mirror æ— æ³•è¯†åˆ«
        run: |
          python3 -c "
          import os
          import json
          import hashlib

          mirror_root = 'public/tf-mirror'
          
          # éåŽ† mirror ç›®å½•
          for root, dirs, files in os.walk(mirror_root):
              # æŸ¥æ‰¾åŒ…å« .zip æ–‡ä»¶çš„ç›®å½• (é€šå¸¸æ˜¯ .../version/os_arch/)
              # å®˜æ–¹ç»“æž„: registry.terraform.io/hashicorp/name/version/os_arch/file.zip
              
              # æˆ‘ä»¬éœ€è¦æ‰¾åˆ° 'provider' è¿™ä¸€å±‚æ¥ç”Ÿæˆ index.json
              # è·¯å¾„ç‰¹å¾: .../hashicorp/{name} ä¸‹é¢åº”è¯¥æ”¾ index.json
              
              if 'hashicorp' in root.split(os.sep):
                  # å°è¯•å®šä½ provider æ ¹ç›®å½•
                  parts = root.split(os.sep)
                  try:
                      idx = parts.index('hashicorp')
                      provider_name = parts[idx+1]
                      provider_root = os.path.join(*parts[:idx+2]) # .../hashicorp/name
                      
                      # å¦‚æžœå·²ç»å¤„ç†è¿‡è¿™ä¸ª providerï¼Œè·³è¿‡
                      if os.path.exists(os.path.join(provider_root, 'index.json')):
                          continue
                          
                      print(f'Creating index for: {provider_name}')
                      
                      versions_data = {}
                      
                      # æ‰«æè¯¥ provider ä¸‹çš„æ‰€æœ‰ç‰ˆæœ¬
                      for v_ver in os.listdir(provider_root):
                          ver_path = os.path.join(provider_root, v_ver)
                          if not os.path.isdir(ver_path): continue
                          
                          platforms = []
                          # æ‰«æè¯¥ç‰ˆæœ¬ä¸‹çš„æ‰€æœ‰æž¶æž„ (linux_amd64, windows_amd64...)
                          for v_arch in os.listdir(ver_path):
                              arch_path = os.path.join(ver_path, v_arch)
                              if not os.path.isdir(arch_path): continue
                              
                              # æ‰¾ zip æ–‡ä»¶
                              zips = [f for f in os.listdir(arch_path) if f.endswith('.zip')]
                              if zips:
                                  zip_file = zips[0]
                                  zip_full_path = os.path.join(arch_path, zip_file)
                                  
                                  # è®¡ç®— SHA256 (è™½ç„¶ network_mirror åè®®ä¸å¼ºåˆ¶è¦æ±‚åœ¨è¿™é‡Œæ”¾ hashï¼Œä½†ç”Ÿæˆå®Œæ•´çš„æ›´å¥½)
                                  # å…³é”®æ˜¯è®°å½• os å’Œ arch
                                  os_type, arch_type = v_arch.split('_')
                                  
                                  # æž„é€ ç›¸å¯¹ä¸‹è½½è·¯å¾„
                                  # ç»“æž„: version/os_arch/filename
                                  dl_path = f'{v_ver}/{v_arch}/{zip_file}'
                                  
                                  platforms.append({
                                      'os': os_type, 
                                      'arch': arch_type,
                                      'filename': zip_file,
                                      'download_url': zip_file, # ç›¸å¯¹è·¯å¾„ï¼Œå®žé™…åè®®å¤„ç†ä¼šæœ‰å·®å¼‚ï¼Œä½†å¯¹äºŽé™æ€æ–‡ä»¶æœåŠ¡ï¼Œåªè¦è·¯å¾„å¯¹å°±è¡Œ
                                      # æ³¨æ„ï¼šindex.json çš„ url æ˜¯ç›¸å¯¹äºŽ version ç›®å½•çš„ï¼Œè¿˜æ˜¯ç›¸å¯¹äºŽ provider æ ¹ç›®å½•çš„ï¼Ÿ
                                      # æ ¹æ®åè®®ï¼Œindex.json é‡Œçš„ url å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ã€‚
                                      # ä¸ºäº†ç¨³å¦¥ï¼Œæˆ‘ä»¬è¿™é‡Œä¸æ”¾ download_url å­—æ®µè®©å®ƒèµ°é»˜è®¤ï¼Œ
                                      # æˆ–è€…æŒ‡å‘å…·ä½“çš„ç›¸å¯¹è·¯å¾„: version/arch/file
                                  })
                          
                          if platforms:
                              versions_data[v_ver] = {
                                  'protocols': ['5.0'],
                                  'platforms': platforms
                              }

                      # å†™å…¥ index.json
                      if versions_data:
                          with open(os.path.join(provider_root, 'index.json'), 'w') as f:
                              json.dump({'versions': versions_data}, f, indent=2)

                  except IndexError:
                      pass
          "

      - name: Verify Content
        run: |
          echo "ðŸ“‚ Checking random provider structure:"
          ls -R public/tf-mirror/registry.terraform.io/hashicorp/random/ || echo "Random not found"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          commit_message: "Mirror: Native Lock Sync"
