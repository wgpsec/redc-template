name: Sync TF Mirror (Official Tools)

on:
  # æ¯å‘¨æ—¥å‡Œæ™¨ 4 ç‚¹è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
  schedule:
    - cron: '0 4 * * 0'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "latest"

      - name: Prepare Mirror Config
        run: |
          # 1. åˆ›å»ºå·¥ä½œç›®å½•
          mkdir -p tf-build
          cd tf-build

          # 2. ç”Ÿæˆ main.tfï¼ŒåªåŒ…å«å®˜æ–¹è½»é‡çº§å·¥å…·ç±»æ’ä»¶
          # æ³¨æ„ï¼šä¸è¦åŒ…å« AWS/Azure ç­‰å¤§åž‹æ’ä»¶ï¼Œä»¥å…è¶…å‡º GitHub Pages é™åˆ¶
          cat > main.tf <<EOF
          terraform {
            required_providers {
              random   = { source = "hashicorp/random" }
              null     = { source = "hashicorp/null" }
              time     = { source = "hashicorp/time" }
              local    = { source = "hashicorp/local" }
              tls      = { source = "hashicorp/tls" }
              http     = { source = "hashicorp/http" }
              archive  = { source = "hashicorp/archive" }
              external = { source = "hashicorp/external" }
            }
          }
          EOF

      - name: Download and Lock Providers (Multi-Arch)
        working-directory: ./tf-build
        run: |
          # åˆå§‹åŒ–
          terraform init

          # é”å®šå¤šå¹³å°ç‰ˆæœ¬ (Windows, Linux, macOS)
          # è¿™ä¸€æ­¥ä¼šä¸‹è½½å„å¹³å°çš„æ ¡éªŒå’Œï¼Œç¡®ä¿ mirror å‘½ä»¤èƒ½æ‹‰å–åˆ°æ‰€æœ‰å¹³å°çš„åŒ…
          echo "ðŸ”’ Locking dependencies for cross-platform..."
          terraform providers lock \
            -platform=linux_amd64 \
            -platform=linux_arm64 \
            -platform=darwin_amd64 \
            -platform=darwin_arm64 \
            -platform=windows_amd64

      - name: Build Mirror
        working-directory: ./tf-build
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•ç»“æž„
          # æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦æŠŠå®ƒä»¬æ”¾åœ¨ public/tf-mirror ä¸‹
          mkdir -p ../public/tf-mirror

          # æ‰§è¡Œé•œåƒå‘½ä»¤
          echo "ðŸ“¦ Mirroring providers..."
          terraform providers mirror ../public/tf-mirror

      - name: Verify Mirror Content
        run: |
          echo "âœ… Listing mirrored files:"
          ls -R public/tf-mirror

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          commit_message: "Mirror: Sync official tools to /tf-mirror"
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
