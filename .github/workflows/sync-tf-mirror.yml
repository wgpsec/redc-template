name: Sync TF Mirror

on:
  schedule:
    - cron: '0 4 * * 0' # æ¯å‘¨æ—¥å‡Œæ™¨ 4 ç‚¹è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:    # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Secure Sync & Verify
        shell: python
        run: |
          import json
          import urllib.request
          import urllib.error
          import shutil
          import os
          import sys
          import datetime
          import textwrap
          import hashlib
          import binascii
          import base64
          from pathlib import Path
          from concurrent.futures import ThreadPoolExecutor, as_completed

          # ==============================================================================
          # 1. å…¨å±€é…ç½® (Configuration)
          # ==============================================================================
          
          # [å¿…é¡»ä¿®æ”¹] æ‚¨çš„é•œåƒç«™åœ°å€ï¼Œå¿…é¡»ä»¥ / ç»“å°¾
          MIRROR_URL = 'https://redc.wgpsec.org/tf-mirror/'

          # éœ€è¦åŒæ­¥çš„ Provider åˆ—è¡¨
          PROVIDERS = [
              'random', 'null', 'time', 'local', 
              'tls', 'http', 'archive', 'external'
          ]
          
          # éœ€è¦åŒæ­¥çš„æ“ä½œç³»ç»Ÿå’Œæ¶æ„
          TARGET_PLATFORMS = [
              ('linux', 'amd64'), ('linux', 'arm64'),
              ('windows', 'amd64'),
              ('darwin', 'amd64'), ('darwin', 'arm64')
          ]
          
          MIRROR_ROOT = Path('public/tf-mirror')
          REGISTRY_API = 'https://registry.terraform.io/v1/providers'
          MAX_WORKERS = 4  # å¹¶å‘ä¸‹è½½æ•°

          # ==============================================================================
          # 2. æ ¸å¿ƒé€»è¾‘ (Core Logic)
          # ==============================================================================

          class MirrorSync:
              def __init__(self, base_dir: Path):
                  self.base_dir = base_dir

              def fetch_json(self, url):
                  """ä» Terraform Registry API è·å–å…ƒæ•°æ®"""
                  req = urllib.request.Request(url, headers={'User-Agent': 'TF-Mirror-Bot'})
                  with urllib.request.urlopen(req, timeout=15) as r:
                      return json.loads(r.read().decode())

              def verify_and_convert_hash(self, file_path: Path, expected_hex: str):
                  """
                  [æ ¸å¿ƒå®‰å…¨é€»è¾‘]
                  1. è¯»å–å·²ä¸‹è½½æ–‡ä»¶çš„å†…å®¹ï¼Œè®¡ç®—æœ¬åœ° SHA256 (Hex)ã€‚
                  2. ä¸å®˜æ–¹ API è¿”å›çš„ expected_hex è¿›è¡Œæ¯”å¯¹ã€‚
                  3. å¦‚æœä¸€è‡´ï¼Œå°† Hex è½¬æ¢ä¸º Terraform éœ€è¦çš„ h1:Base64 æ ¼å¼ã€‚
                  """
                  print(f"   ğŸ›¡ï¸  Verifying checksum for {file_path.name}...")
                  sha256 = hashlib.sha256()
                  
                  # åˆ†å—è¯»å–æ–‡ä»¶ï¼Œè®¡ç®— Hash (é¿å…å¤§æ–‡ä»¶æ’‘çˆ†å†…å­˜)
                  with open(file_path, 'rb') as f:
                      for block in iter(lambda: f.read(4096), b""):
                          sha256.update(block)
                  
                  local_hex = sha256.hexdigest()
                  
                  # === æ­¥éª¤ A: å®‰å…¨æ¯”å¯¹ ===
                  if local_hex != expected_hex:
                      print(f"   âŒ CRITICAL: Hash Mismatch!")
                      print(f"      Expected: {expected_hex}")
                      print(f"      Actual:   {local_hex}")
                      return None # æ ¡éªŒå¤±è´¥
                  
                  # === æ­¥éª¤ B: æ ¼å¼è½¬æ¢ ===
                  # Terraform Network Mirror åè®®è¦æ±‚: "h1:" + Base64ç¼–ç çš„äºŒè¿›åˆ¶Hash
                  binary_hash = sha256.digest() # è·å–äºŒè¿›åˆ¶æ‘˜è¦
                  b64_hash = base64.b64encode(binary_hash).decode('utf-8')
                  return f"h1:{b64_hash}"

              def download_file(self, url, dest_path: Path):
                  """ä¸‹è½½æ–‡ä»¶ï¼Œå¦‚æœå·²å­˜åœ¨åˆ™è·³è¿‡"""
                  if dest_path.exists() and dest_path.stat().st_size > 0:
                      return 'SKIP'
                  try:
                      dest_path.parent.mkdir(parents=True, exist_ok=True)
                      req = urllib.request.Request(url, headers={'User-Agent': 'TF-Mirror-Bot'})
                      with urllib.request.urlopen(req, timeout=60) as r, open(dest_path, 'wb') as f:
                          shutil.copyfileobj(r, f)
                      return 'OK'
                  except Exception as e:
                      if dest_path.exists(): dest_path.unlink() # ä¸‹è½½å¤±è´¥æ¸…ç†åƒåœ¾
                      raise e

              def process_single_arch(self, namespace, type_name, version, os_name, arch, provider_dir):
                  """å¤„ç†å•ä¸ªæ¶æ„ï¼šä¸‹è½½ -> æ ¡éªŒ -> è¿”å›å…ƒæ•°æ®"""
                  try:
                      # 1. è°ƒç”¨ API è·å–ä¸‹è½½é“¾æ¥å’Œå®˜æ–¹ Hash
                      dl_api = f'{REGISTRY_API}/{namespace}/{type_name}/{version}/download/{os_name}/{arch}'
                      dl_info = self.fetch_json(dl_api)
                      
                      filename = dl_info['filename']
                      file_url = dl_info['download_url']
                      official_hex = dl_info['shasum'] # å®˜æ–¹å®£ç§°çš„ Hash (Hexæ ¼å¼)
                      
                      dest = provider_dir / filename
                      
                      # 2. ä¸‹è½½æ–‡ä»¶
                      self.download_file(file_url, dest)
                      
                      # 3. [å…³é”®] æœ¬åœ°è®¡ç®— Hash å¹¶ä¸å®˜æ–¹æ¯”å¯¹
                      tf_hash = self.verify_and_convert_hash(dest, official_hex)
                      
                      if not tf_hash:
                          # æ ¡éªŒå¤±è´¥ï¼Œç«‹å³åˆ é™¤æ–‡ä»¶ï¼Œé˜²æ­¢æ±¡æŸ“é•œåƒ
                          if dest.exists(): dest.unlink()
                          raise ValueError("Checksum verification failed (Local vs Official)")

                      return {
                          "status": "success",
                          "os": os_name,
                          "arch": arch,
                          "filename": filename,
                          "hash": tf_hash # éªŒè¯é€šè¿‡åçš„ h1 Hash
                      }
                  except urllib.error.HTTPError:
                      return {"status": "skipped"} # æ¶æ„ä¸å­˜åœ¨
                  except Exception as e:
                      return {"status": "failed", "error": str(e)}

              def process_provider(self, full_name):
                  """å¤„ç†å•ä¸ª Provider å…¨æµç¨‹"""
                  if '/' in full_name:
                      namespace, type_name = full_name.split('/')
                  else:
                      namespace = 'hashicorp'
                      type_name = full_name

                  print(f'ğŸ” Analyzing {namespace}/{type_name}...')
                  
                  try:
                      # 1. è·å–ç‰ˆæœ¬
                      meta_url = f'{REGISTRY_API}/{namespace}/{type_name}'
                      meta = self.fetch_json(meta_url)
                      version = meta['version']
                      
                      # ç›®å½•ç»“æ„: public/tf-mirror/registry.terraform.io/NAMESPACE/TYPE/
                      provider_dir = self.base_dir / 'registry.terraform.io' / namespace / type_name
                      provider_dir.mkdir(parents=True, exist_ok=True)
                      
                      archives_data = {}
                      
                      # 2. å¹¶å‘å¤„ç†æ‰€æœ‰æ¶æ„
                      with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
                          futures = []
                          for os_name, arch in TARGET_PLATFORMS:
                              futures.append(executor.submit(
                                  self.process_single_arch, 
                                  namespace, type_name, version, os_name, arch, provider_dir
                              ))
                          
                          for future in as_completed(futures):
                              res = future.result()
                              if res["status"] == "success":
                                  key = f"{res['os']}_{res['arch']}"
                                  print(f"   âœ… Verified & Ready: {res['filename']}")
                                  archives_data[key] = {
                                      "url": res['filename'],
                                      "hashes": [res['hash']]
                                  }
                              elif res["status"] == "failed":
                                  print(f"   âŒ Failed: {res.get('error')}")

                      # 3. ç”Ÿæˆç´¢å¼•æ–‡ä»¶
                      if archives_data:
                          # index.json
                          index_data = {"versions": {version: {}}}
                          with open(provider_dir / 'index.json', 'w') as f:
                              json.dump(index_data, f, indent=2)

                          # VERSION.json (å¦‚ 3.8.1.json)
                          version_file_data = {"archives": archives_data}
                          with open(provider_dir / f'{version}.json', 'w') as f:
                              json.dump(version_file_data, f, indent=2)
                          
                          return {'name': type_name, 'namespace': namespace, 'version': version, 'status': 'success'}
                      else:
                           return {'name': type_name, 'namespace': namespace, 'version': version, 'status': 'empty'}

                  except Exception as e:
                      print(f'ğŸš« Error processing {namespace}/{type_name}: {e}')
                      return {'name': type_name, 'namespace': namespace, 'version': 'Error', 'status': 'failed'}

          # ==============================================================================
          # 3. ä¸»ç¨‹åºæ‰§è¡Œ (Main Execution)
          # ==============================================================================
          
          # æ¸…ç†æ—§ç›®å½•
          if MIRROR_ROOT.exists():
              print("ğŸ§¹ Cleaning up old mirror directory...")
              shutil.rmtree(MIRROR_ROOT)
          MIRROR_ROOT.mkdir(parents=True, exist_ok=True)

          syncer = MirrorSync(MIRROR_ROOT)
          results = []
          
          with ThreadPoolExecutor(max_workers=3) as main_executor:
              futures = {main_executor.submit(syncer.process_provider, p): p for p in PROVIDERS}
              for f in as_completed(futures):
                  res = f.result()
                  results.append(res)
                  
                  ns = res.get('namespace', 'unknown')
                  nm = res.get('name', 'unknown')
                  if res.get('status') == 'success':
                      print(f"ğŸ‰ Completed {ns}/{nm}")
                  else:
                      print(f"âš ï¸ Skipped {ns}/{nm}")

          # ==============================================================================
          # 4. ç”Ÿæˆ HTML ç´¢å¼•é¡µé¢
          # ==============================================================================
          print('ğŸ“ Generating index.html...')
          timestamp = datetime.datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')
          
          sorted_results = sorted(results, key=lambda x: (x.get('namespace', ''), x.get('name', '')))
          
          # ç”Ÿæˆ Terraform include é…ç½®å—
          config_lines = []
          for r in sorted_results:
              if r.get('status') == 'success':
                   config_lines.append(f'"registry.terraform.io/{r["namespace"]}/{r["name"]}"')
          config_str = ",\n    ".join(config_lines)
          
          # ç”Ÿæˆå¡ç‰‡ HTML
          cards_html = ""
          for r in sorted_results:
              if r.get('status') == 'success':
                  cards_html += f"""
                  <div class="card">
                      <div class="name">{r['namespace']}/{r['name']}</div>
                      <div class="ver">v{r['version']}</div>
                  </div>
                  """

          html_template = textwrap.dedent("""
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Terraform Provider Mirror</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 2rem; color: #333; line-height: 1.6; }
                  h1 { border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
                  .status { background: #f6f8fa; padding: 1rem; border-radius: 6px; margin-bottom: 2rem; border: 1px solid #e1e4e8; }
                  code { background: #eee; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
                  pre { background: #2d333b; color: #adbac7; padding: 1.5rem; border-radius: 6px; overflow-x: auto; font-family: monospace; }
                  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
                  .card { border: 1px solid #e1e4e8; border-radius: 6px; padding: 1rem; transition: transform 0.2s; }
                  .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                  .name { font-weight: bold; color: #0366d6; margin-bottom: 0.5rem; }
                  .ver { font-size: 0.85em; color: #586069; background: #f1f8ff; display: inline-block; padding: 2px 8px; border-radius: 12px; }
                  footer { margin-top: 3rem; text-align: center; color: #666; font-size: 0.85rem; border-top: 1px solid #eee; padding-top: 1rem; }
              </style>
          </head>
          <body>
              <h1>Terraform Provider Mirror</h1>
              <div class="status">
                  <p><strong>Protocol:</strong> Network Mirror (Strict Integrity Check)</p>
                  <p><strong>Last Updated:</strong> {{TIMESTAMP}}</p>
                  <p><strong>Mirror URL:</strong> <code>{{MIRROR_URL}}</code></p>
              </div>

              <h2>Usage Configuration</h2>
              <p>Add the following to your <code>~/.terraformrc</code>:</p>
              <pre>
          provider_installation {
            network_mirror {
              url = "{{MIRROR_URL}}"
              include = [
                {{CONFIG_STR}}
              ]
            }
            direct {
              exclude = [
                {{CONFIG_STR}}
              ]
            }
          }</pre>

              <h2>Synced Providers ({{COUNT}})</h2>
              <div class="grid">
                  {{CARDS_HTML}}
              </div>
              
              <footer>
                  wgpsec terraform mirror | <a href="https://github.com/wgpsec/redc-template">Source Repository</a>
              </footer>
          </body>
          </html>
          """)
          
          final_html = html_template.replace("{{TIMESTAMP}}", timestamp) \
                                    .replace("{{MIRROR_URL}}", MIRROR_URL) \
                                    .replace("{{CONFIG_STR}}", config_str) \
                                    .replace("{{COUNT}}", str(len(config_lines))) \
                                    .replace("{{CARDS_HTML}}", cards_html)
          
          with open(MIRROR_ROOT / 'index.html', 'w', encoding='utf-8') as f:
              f.write(final_html)
          print('âœ… index.html created successfully.')

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          commit_message: "Mirror: Sync providers with Strict Local Hash Verification"
