name: Sync TF Mirror (Force Cross-Platform)

on:
  schedule:
    - cron: '0 4 * * 0' # æ¯å‘¨æ—¥è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Force Sync Multi-Arch Providers
        run: |
          # åˆ›å»ºé•œåƒæ ¹ç›®å½•
          mkdir -p public/tf-mirror
          
          # æ‰§è¡Œ Python è„šæœ¬
          python3 -c "
          import json
          import urllib.request
          import urllib.error
          import shutil
          import os
          import sys
          from pathlib import Path
          from concurrent.futures import ThreadPoolExecutor, as_completed

          # ================= é…ç½®åŒºåŸŸ =================
          # å¸¸ç”¨å®˜æ–¹å°å·¥å…·
          PROVIDERS = [
              'random', 'null', 'time', 'local', 
              'tls', 'http', 'archive', 'external'
          ]
          
          # å¼ºåˆ¶åŒæ­¥çš„å¹³å°åˆ—è¡¨ (Windows, Linux, macOS)
          TARGET_PLATFORMS = [
              ('linux', 'amd64'), ('linux', 'arm64'),
              ('windows', 'amd64'),
              ('darwin', 'amd64'), ('darwin', 'arm64')
          ]
          
          MIRROR_ROOT = Path('public/tf-mirror')
          REGISTRY_API = 'https://registry.terraform.io/v1/providers/hashicorp'
          MAX_WORKERS = 4
          # ===========================================

          class MirrorSync:
              def __init__(self, base_dir: Path):
                  self.base_dir = base_dir

              def fetch_json(self, url):
                  req = urllib.request.Request(url, headers={'User-Agent': 'TF-Mirror-Bot'})
                  with urllib.request.urlopen(req, timeout=15) as r:
                      return json.loads(r.read().decode())

              def download_file(self, url, dest_path: Path):
                  if dest_path.exists() and dest_path.stat().st_size > 0:
                      return f'â© Skip: {dest_path.name}'
                  
                  try:
                      dest_path.parent.mkdir(parents=True, exist_ok=True)
                      req = urllib.request.Request(url, headers={'User-Agent': 'TF-Mirror-Bot'})
                      with urllib.request.urlopen(req, timeout=60) as r, open(dest_path, 'wb') as f:
                          shutil.copyfileobj(r, f)
                      return f'â¬‡ï¸  Downloaded: {dest_path.name}'
                  except Exception as e:
                      if dest_path.exists(): dest_path.unlink()
                      return f'âŒ Failed: {dest_path.name} ({e})'

              def process_provider(self, name):
                  print(f'ğŸ” Analyzing hashicorp/{name}...')
                  try:
                      # 1. è·å–æœ€æ–°ç‰ˆæœ¬
                      meta = self.fetch_json(f'{REGISTRY_API}/{name}')
                      version = meta['version']
                      
                      # å‡†å¤‡ç›®å½•ç»“æ„
                      # æ ¼å¼: registry.terraform.io/hashicorp/{name}/{version}/{os}_{arch}/
                      provider_dir = self.base_dir / 'registry.terraform.io' / 'hashicorp' / name
                      
                      # 2. å‡†å¤‡ä¸‹è½½ä»»åŠ¡
                      tasks = {}
                      platform_meta = []
                      
                      with ThreadPoolExecutor(max_workers=MAX_WORKERS) as executor:
                          # A. ä¸‹è½½å„å¹³å° ZIP åŒ…
                          for os_name, arch in TARGET_PLATFORMS:
                              try:
                                  dl_api = f'{REGISTRY_API}/{name}/{version}/download/{os_name}/{arch}'
                                  dl_info = self.fetch_json(dl_api)
                                  
                                  filename = dl_info['filename']
                                  file_url = dl_info['download_url']
                                  
                                  # æœ¬åœ°å­˜æ”¾è·¯å¾„
                                  save_dir = provider_dir / version / f'{os_name}_{arch}'
                                  dest = save_dir / filename
                                  
                                  tasks[executor.submit(self.download_file, file_url, dest)] = f'{os_name}/{arch}'
                                  
                                  # è®°å½•åˆ°ç´¢å¼•å…ƒæ•°æ®ä¸­
                                  platform_meta.append({'os': os_name, 'arch': arch})
                                  
                              except urllib.error.HTTPError as e:
                                  print(f'   âš ï¸ {name} {version} not found for {os_name}/{arch}')

                          # B. ä¸‹è½½ SHA256SUMS å’Œ ç­¾å (é‡è¦! Terraform æ ¡éªŒéœ€è¦)
                          # é€šå¸¸åœ¨ä»»æ„ä¸€ä¸ªä¸‹è½½é“¾æ¥çš„åŒçº§ç›®å½•
                          if 'file_url' in locals():
                              base_url_sums = file_url.rsplit('/', 1)[0]
                              sums_name = f'terraform-provider-{name}_{version}_SHA256SUMS'
                              
                              # å­˜æ”¾åˆ° version æ ¹ç›®å½•
                              version_root = provider_dir / version
                              tasks[executor.submit(self.download_file, f'{base_url_sums}/{sums_name}', version_root / sums_name)] = 'SHA256SUMS'
                              tasks[executor.submit(self.download_file, f'{base_url_sums}/{sums_name}.sig', version_root / f'{sums_name}.sig')] = 'Signature'

                          # ç­‰å¾…æ‰€æœ‰ä¸‹è½½å®Œæˆ
                          for future in as_completed(tasks):
                              print(f'   {future.result()}')

                      # 3. ç”Ÿæˆ index.json (å…³é”®! Network Mirror åè®®)
                      # è·¯å¾„: registry.terraform.io/hashicorp/{name}/index.json
                      index_data = {
                          'versions': {
                              version: {
                                  'protocols': ['5.0'],
                                  'platforms': platform_meta
                              }
                          }
                      }
                      with open(provider_dir / 'index.json', 'w') as f:
                          json.dump(index_data, f, indent=2)
                      
                      return f'âœ… Finished: {name} v{version}'

                  except Exception as e:
                      return f'ğŸš« Error: {name} - {e}'

          # --- ä¸»ç¨‹åº ---
          syncer = MirrorSync(MIRROR_ROOT)
          
          # å¹¶å‘å¤„ç†å¤šä¸ª Provider
          with ThreadPoolExecutor(max_workers=3) as main_executor:
              futures = {main_executor.submit(syncer.process_provider, p): p for p in PROVIDERS}
              for f in as_completed(futures):
                  print(f.result())
          "

      - name: Verify Windows Files
        run: |
          echo "ğŸ“‚ Checking for Windows binaries:"
          find public/tf-mirror -name "*windows_amd64*" | head -n 5 || echo "No windows files found"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          commit_message: "Mirror: Force sync Windows/Linux/Mac tools"
