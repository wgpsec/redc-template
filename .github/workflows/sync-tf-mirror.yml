name: Sync TF Mirror

on:
  schedule:
    - cron: '0 4 * * 0' # æ¯å‘¨æ—¥è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  native-mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "latest"

      # 1. ç”Ÿæˆé…ç½®æ–‡ä»¶ (åªåŒ…å« HashiCorp å®˜æ–¹æ’ä»¶)
      - name: Create Target Config
        run: |
          cat > main.tf <<EOF
          terraform {
            required_providers {
              random   = { source = "hashicorp/random" }
              null     = { source = "hashicorp/null" }
              time     = { source = "hashicorp/time" }
              local    = { source = "hashicorp/local" }
              tls      = { source = "hashicorp/tls" }
              http     = { source = "hashicorp/http" }
              archive  = { source = "hashicorp/archive" }
              external = { source = "hashicorp/external" }
            }
          }
          EOF

      # 2. ã€å…³é”®ä¿®å¤ã€‘åˆå§‹åŒ– Terraform
      # mirror å‘½ä»¤å¿…é¡»åœ¨å·²åˆå§‹åŒ–çš„é¡¹ç›®ä¸­è¿è¡Œï¼Œå¦åˆ™å®ƒä¸çŸ¥é“ç‰ˆæœ¬ä¿¡æ¯
      - name: Terraform Init
        run: terraform init

      # 3. æ‰§è¡Œå®˜æ–¹é•œåƒå‘½ä»¤
      # è¿™ä¼šè‡ªåŠ¨å¤„ç†ä¸‹è½½ã€æ ¡éªŒã€ç”Ÿæˆ JSONã€è®¡ç®— Hashã€ç›®å½•ç»“æž„
      - name: Run Terraform Mirror
        run: |
          mkdir -p public/tf-mirror
          
          terraform providers mirror \
            -platform=linux_amd64 \
            -platform=linux_arm64 \
            -platform=windows_amd64 \
            -platform=darwin_amd64 \
            -platform=darwin_arm64 \
            ./public/tf-mirror

      # 4. ç”Ÿæˆ HTML ç´¢å¼•é¡µé¢
      - name: Generate HTML Index
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Build HTML
        shell: python
        run: |
          import os
          import json
          import datetime
          import textwrap
          from pathlib import Path

          MIRROR_ROOT = Path('public/tf-mirror')
          # [!] è¯·ä¿®æ”¹ä¸ºæ‚¨çš„å®žé™… GitHub Pages åœ°å€
          MIRROR_URL = 'https://redc.wgpsec.org/tf-mirror/'

          print('ðŸ“ Generating index.html...')
          providers = []

          # éåŽ† Terraform ç”Ÿæˆçš„æ ‡å‡†ç›®å½•ç»“æž„
          base_registry = MIRROR_ROOT / 'registry.terraform.io'
          
          if base_registry.exists():
              for namespace in base_registry.iterdir():
                  if namespace.is_dir():
                      for name in namespace.iterdir():
                          if name.is_dir():
                              # è¯»å– index.json èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
                              index_path = name / 'index.json'
                              if index_path.exists():
                                  try:
                                      with open(index_path) as f:
                                          data = json.load(f)
                                          # èŽ·å–æœ€æ–°ç‰ˆæœ¬å·
                                          versions = sorted(data.get('versions', {}).keys(), reverse=True)
                                          latest_ver = versions[0] if versions else 'unknown'
                                          
                                          providers.append({
                                              'namespace': namespace.name,
                                              'name': name.name,
                                              'version': latest_ver
                                          })
                                  except:
                                      pass

          # ç”Ÿæˆ HTML
          timestamp = datetime.datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')
          
          # æŽ’åº: namespace -> name
          sorted_providers = sorted(providers, key=lambda x: (x['namespace'], x['name']))
          
          config_lines = [f'"registry.terraform.io/{p["namespace"]}/{p["name"]}"' for p in sorted_providers]
          config_str = ",\n    ".join(config_lines)
          
          cards_html = ""
          for p in sorted_providers:
              cards_html += f"""
              <div class="card">
                  <div class="name">{p['namespace']}/{p['name']}</div>
                  <div class="ver">v{p['version']}</div>
              </div>
              """

          html_template = textwrap.dedent("""
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Terraform Provider Mirror</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 2rem; color: #333; line-height: 1.6; }
                  h1 { border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
                  .status { background: #f6f8fa; padding: 1rem; border-radius: 6px; margin-bottom: 2rem; border: 1px solid #e1e4e8; }
                  code { background: #eee; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
                  pre { background: #2d333b; color: #adbac7; padding: 1.5rem; border-radius: 6px; overflow-x: auto; font-family: monospace; }
                  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
                  .card { border: 1px solid #e1e4e8; border-radius: 6px; padding: 1rem; transition: transform 0.2s; }
                  .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                  .name { font-weight: bold; color: #0366d6; margin-bottom: 0.5rem; }
                  .ver { font-size: 0.85em; color: #586069; background: #f1f8ff; display: inline-block; padding: 2px 8px; border-radius: 12px; }
                  footer { margin-top: 3rem; text-align: center; color: #666; font-size: 0.85rem; border-top: 1px solid #eee; padding-top: 1rem; }
              </style>
          </head>
          <body>
              <h1>Terraform Provider Mirror</h1>
              <div class="status">
                  <p><strong>Method:</strong> Native CLI (Strict Official)</p>
                  <p><strong>Last Updated:</strong> {{TIMESTAMP}}</p>
                  <p><strong>Mirror URL:</strong> <code>{{MIRROR_URL}}</code></p>
              </div>

              <h2>Usage Configuration</h2>
              <p>Add the following to your <code>~/.terraformrc</code>:</p>
              <pre>
          provider_installation {
            network_mirror {
              url = "{{MIRROR_URL}}"
              include = [
                {{CONFIG_STR}}
              ]
            }
            direct {
              exclude = [
                {{CONFIG_STR}}
              ]
            }
          }</pre>

              <h2>Synced Providers ({{COUNT}})</h2>
              <div class="grid">
                  {{CARDS_HTML}}
              </div>
              
              <footer>
                  wgpsec terraform mirror | <a href="https://github.com/wgpsec/redc-template">Source Repository</a>
              </footer>
          </body>
          </html>
          """)
          
          final_html = html_template.replace("{{TIMESTAMP}}", timestamp) \
                                    .replace("{{MIRROR_URL}}", MIRROR_URL) \
                                    .replace("{{CONFIG_STR}}", config_str) \
                                    .replace("{{COUNT}}", str(len(providers))) \
                                    .replace("{{CARDS_HTML}}", cards_html)
          
          with open(MIRROR_ROOT / 'index.html', 'w', encoding='utf-8') as f:
              f.write(final_html)

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          commit_message: "Mirror: Sync using Native Terraform CLI with Init"
