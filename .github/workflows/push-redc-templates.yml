- name: Build with Bash & jq
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          FORCE_REBUILD: ${{ inputs.force_rebuild }}
        run: |
          # --- 0. èŽ·å–ç»å¯¹è·¯å¾„ (å…³é”®ä¿®å¤) ---
          # è®°å½•å½“å‰ä»“åº“æ ¹ç›®å½•çš„ç»å¯¹è·¯å¾„
          ROOT_DIR=$(pwd)

          # --- 1. åˆå§‹åŒ–å˜é‡ä¸ŽçŽ¯å¢ƒ ---
          mkdir -p public/templates
          [ -f index.html ] && cp index.html public/index.html

          BASE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}"
          OUTPUT_JSON="public/index.json"
          PREV_JSON="previous_build/index.json"
          
          # åˆå§‹åŒ–æ–°çš„ JSON ç»“æž„
          jq -n \
            --arg date "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --arg repo "$REPO_NAME" \
            '{updated_at: $date, repo_name: $repo, templates: []}' > "$OUTPUT_JSON"

          # --- 2. éåŽ†åŒå±‚ç›®å½• ---
          for provider in */ ; do
            provider=${provider%/}
            # æŽ’é™¤éžæ¨¡ç‰ˆç›®å½•
            if [[ "$provider" == "public" || "$provider" == "previous_build" || "$provider" == .* ]]; then continue; fi

            for template in "$provider"/*/ ; do
              template=${template%/}
              template_name=$(basename "$template")
              
              if [[ ! -d "$template" ]]; then continue; fi
              
              id="${provider}/${template_name}"
              zip_name="${provider}_${template_name}.zip"
              
              # æ³¨æ„ï¼šè¿™é‡Œçš„ zip_path æ˜¯ç›¸å¯¹äºŽ ROOT_DIR çš„
              zip_path="public/templates/$zip_name"
              prev_zip_path="previous_build/templates/$zip_name"
              
              echo "ðŸ” Checking: $id"

              # --- 3. è®¡ç®—æºç æŒ‡çº¹ ---
              current_src_hash=$(find "$template" -type f -not -path '*/.*' -print0 | sort -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')

              # --- 4. å¢žé‡åˆ¤æ–­é€»è¾‘ ---
              should_rebuild="true"
              old_entry="null"
              
              if [[ -f "$PREV_JSON" ]]; then
                old_entry=$(jq --arg id "$id" '.templates[] | select(.id == $id)' "$PREV_JSON")
              fi
              old_src_hash=$(echo "$old_entry" | jq -r '.source_hash // empty')
              
              if [[ "$FORCE_REBUILD" != "true" && -n "$old_src_hash" && "$old_src_hash" == "$current_src_hash" && -f "$prev_zip_path" ]]; then
                should_rebuild="false"
              fi

              # --- 5. æ‰§è¡Œæž„å»ºæˆ–å¤ç”¨ ---
              final_zip_hash=""
              
              if [[ "$should_rebuild" == "true" ]]; then
                echo "   ðŸ”¨ Building..."
                # ä¿®å¤ç‚¹ï¼šä½¿ç”¨ "$ROOT_DIR/$zip_path" ç»å¯¹è·¯å¾„
                # è¿™æ ·æ— è®º cd åˆ°å“ªé‡Œï¼Œéƒ½èƒ½å‡†ç¡®æ‰¾åˆ° public/templates ç›®å½•
                (cd "$template" && zip -r -q "$ROOT_DIR/$zip_path" .)
                
                final_zip_hash=$(sha256sum "$zip_path" | awk '{print $1}')
              else
                echo "   â© Skipping (Cached)"
                cp "$prev_zip_path" "$zip_path"
                final_zip_hash=$(echo "$old_entry" | jq -r '.sha256')
              fi

              # --- 6. è¯»å– Metadata ---
              meta_name="$template_name"
              meta_author="Unknown"
              meta_desc="No description provided."
              
              case_file="$template/case.json"
              if [[ -f "$case_file" ]]; then
                if jq -e . "$case_file" >/dev/null 2>&1; then
                  meta_name=$(jq -r '.name // "'"$template_name"'"' "$case_file")
                  meta_author=$(jq -r '.user // "Unknown"' "$case_file")
                  meta_desc=$(jq -r '.DESCRIPTION // "No description provided."' "$case_file")
                fi
              fi

              # --- 7. æ›´æ–° index.json ---
              tmp=$(mktemp)
              jq --arg id "$id" \
                 --arg provider "$provider" \
                 --arg slug "$template_name" \
                 --arg url "$BASE_URL/templates/$zip_name" \
                 --arg sha256 "$final_zip_hash" \
                 --arg src_hash "$current_src_hash" \
                 --arg name "$meta_name" \
                 --arg author "$meta_author" \
                 --arg desc "$meta_desc" \
                 '.templates += [{
                    id: $id,
                    provider: $provider,
                    slug: $slug,
                    url: $url,
                    sha256: $sha256,
                    source_hash: $src_hash,
                    metadata: {
                      name: $name,
                      author: $author,
                      description: $desc
                    }
                 }]' "$OUTPUT_JSON" > "$tmp" && mv "$tmp" "$OUTPUT_JSON"
                 
            done
          done
          
          echo "ðŸŽ‰ Build Complete. Index generated at $OUTPUT_JSON"
