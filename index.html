<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redc Template Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-dark.min.css">
    
    <style>
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        body { background-color: #0f172a; color: #e2e8f0; }
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Markdown 弹窗特定样式 */
        .markdown-body {
            background-color: transparent !important;
            font-size: 14px;
        }
        .markdown-body pre {
            background-color: #1e293b !important;
            border: 1px solid #334155;
        }
    </style>
</head>
<body class="min-h-screen p-6 font-sans">
    <div class="max-w-7xl mx-auto">
        <header class="mb-10 text-center pt-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-6">
                Redc Registry
            </h1>
            <p class="text-slate-400 text-lg mb-6">基于 Terraform 的红队基础设施模版仓库</p>
            
            <div class="inline-flex items-center gap-2 px-6 py-3 bg-slate-900/50 rounded-full text-base font-mono text-cyan-400 border border-slate-700 shadow-lg">
                <i data-lucide="terminal" class="w-5 h-5"></i>
                <span>redc pull <span class="text-slate-500">&lt;provider&gt;/&lt;template&gt;</span></span>
            </div>
        </header>

        <div class="mb-10 flex justify-center">
            <div class="relative w-full max-w-xl group">
                <i data-lucide="search" class="absolute left-4 top-3.5 text-slate-500 group-focus-within:text-cyan-400 transition"></i>
                <input type="text" id="search" placeholder="搜索模版 (例如: aws, c2...)" 
                    class="w-full pl-12 pr-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition text-white placeholder-slate-500">
            </div>
        </div>

        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-500">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-4"></i>
                <p>正在加载模版库数据...</p>
            </div>
        </div>

        <footer class="mt-20 border-t border-slate-800 pt-8 text-center text-slate-600 text-sm">
            <p id="build-info">Waiting for data...</p>
        </footer>
    </div>

    <div id="modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-[#0d1117] border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                    
                    <div class="bg-slate-800/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-semibold leading-6 text-white" id="modal-title">Template Details</h3>
                            <p class="text-sm text-slate-400 mt-1" id="modal-subtitle">Provider / Name</p>
                        </div>
                        <button type="button" class="text-slate-400 hover:text-white transition" onclick="closeModal()">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                        <div id="markdown-content" class="markdown-body">
                            </div>
                    </div>

                    <div class="bg-slate-800/50 px-6 py-4 border-t border-slate-700 flex justify-end gap-3">
                        <button type="button" class="inline-flex justify-center rounded-lg bg-slate-700 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-600 ring-1 ring-inset ring-slate-600" onclick="closeModal()">
                            关闭
                        </button>
                        <button type="button" id="modal-copy-btn" class="inline-flex items-center gap-2 justify-center rounded-lg bg-cyan-600 px-4 py-2 text-sm font-semibold text-white hover:bg-cyan-500 shadow-lg shadow-cyan-500/20">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            复制命令
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-cyan-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-32 transition-transform duration-300 flex items-center gap-2 z-50">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        <span>命令已复制!</span>
    </div>

    <script>
        let allTemplates = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        async function fetchData() {
            try {
                const response = await fetch('./index.json');
                if (!response.ok) throw new Error('Failed to load index.json');
                const data = await response.json();
                
                // 处理 dict 结构转 array，方便前端渲染
                // 假设 index.json 结构是 { templates: { "id": { ... } } }
                if (!Array.isArray(data.templates)) {
                    allTemplates = Object.values(data.templates);
                } else {
                    allTemplates = data.templates;
                }

                // 排序：最新的排前面
                allTemplates.sort((a, b) => new Date(b.versions?.[a.latest]?.updated_at || 0) - new Date(a.versions?.[b.latest]?.updated_at || 0));

                const date = new Date(data.updated_at);
                document.getElementById('build-info').innerHTML = `Last Updated: ${date.toLocaleString()} • Repo: ${data.repo_name}`;

                renderTemplates(allTemplates);
            } catch (error) {
                console.error(error);
                document.getElementById('grid').innerHTML = `<div class="col-span-full text-center text-red-400">Error: ${error.message}</div>`;
            }
        }

        function renderTemplates(templates) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            templates.forEach(t => {
                const card = document.createElement('div');
                card.className = 'glass rounded-xl p-5 hover:border-cyan-500/50 hover:bg-slate-800/30 transition duration-300 group flex flex-col h-full relative';
                
                const meta = t.metadata || {};
                const desc = meta.description || '暂无描述';
                const author = meta.author || 'Unknown';
                const version = t.latest || '0.0.1';
                // 获取 README 内容 (可能为空)
                const readme = meta.readme || ''; 

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="px-2 py-1 text-[10px] font-bold bg-cyan-950 text-cyan-400 rounded border border-cyan-900/50 uppercase">
                            ${t.provider || t.id.split('/')[0]}
                        </span>
                        <span class="text-[10px] text-slate-500 font-mono bg-slate-900 px-1.5 py-0.5 rounded">v${version}</span>
                    </div>

                    <h3 class="text-lg font-bold text-slate-100 group-hover:text-cyan-400 transition mb-2 truncate cursor-pointer" 
                        onclick="openModal('${t.id}')">
                        ${meta.name || t.slug}
                    </h3>
                    
                    <p class="text-slate-400 text-sm mb-4 line-clamp-2 h-10 leading-relaxed">
                        ${desc}
                    </p>

                    <div class="mt-auto pt-4 border-t border-slate-700/50 flex flex-col gap-3">
                        <div class="flex items-center justify-between text-xs text-slate-500">
                             <div class="flex items-center gap-1.5">
                                <i data-lucide="user" class="w-3 h-3"></i>
                                <span class="truncate max-w-[80px]">${author}</span>
                            </div>
                            <button onclick="openModal('${t.id}')" class="flex items-center gap-1 text-cyan-400 hover:text-cyan-300 transition hover:underline">
                                <i data-lucide="book-open" class="w-3 h-3"></i>
                                文档
                            </button>
                        </div>
                        
                        <div class="flex gap-2">
                             <button onclick="copyCommand('redc pull ${t.id}')" 
                                class="flex-1 flex items-center justify-center gap-2 py-2 bg-slate-800 hover:bg-cyan-900/30 text-slate-300 hover:text-cyan-400 text-xs font-mono rounded border border-slate-700 transition active:scale-95">
                                <i data-lucide="terminal" class="w-3 h-3"></i>
                                Pull
                            </button>
                             <a href="${t.versions?.[version]?.url || '#'}" class="px-3 flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded border border-slate-700 transition" title="下载 ZIP">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </a>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            lucide.createIcons();
            setupSearch(templates);
        }

        // --- Modal Logic ---
        function openModal(templateId) {
            const t = allTemplates.find(item => item.id === templateId);
            if (!t) return;

            document.getElementById('modal-title').innerText = t.metadata.name || t.slug;
            document.getElementById('modal-subtitle').innerText = `${t.provider} / v${t.latest}`;
            
            // 渲染 README
            const readmeRaw = t.metadata.readme || '> *暂无 README 文档*';
            // 使用 marked 解析
            document.getElementById('markdown-content').innerHTML = marked.parse(readmeRaw);

            // 绑定复制按钮
            const copyBtn = document.getElementById('modal-copy-btn');
            copyBtn.onclick = () => copyCommand(`redc pull ${t.id}`);

            // 显示弹窗
            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 禁止背景滚动
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // ESC 关闭弹窗
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // --- Search Logic ---
        function setupSearch(templates) {
            const searchInput = document.getElementById('search');
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = templates.filter(t => 
                    (t.metadata.name || '').toLowerCase().includes(term) || 
                    (t.metadata.description || '').toLowerCase().includes(term) ||
                    t.id.toLowerCase().includes(term)
                );
                renderTemplates(filtered);
            });
        }

        function copyCommand(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.remove('translate-y-32');
                setTimeout(() => {
                    toast.classList.add('translate-y-32');
                }, 2000);
            });
        }
    </script>
</body>
</html>
